<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo de Proyectos en Costa Rica</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Cargar fuente Montserrat desde Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; }
        #map {
            height: 80vh; /* Altura por defecto para computadoras */
            width: 100%; /* Ajustado a 100% para ocupar todo el ancho */
            margin: 0; /* Eliminar márgenes para maximizar espacio */
            min-height: 300px;
            position: relative; /* Para posicionar el botón dentro del mapa */
            transition: height 0.3s ease; /* Transición suave para cambios de tamaño */
        }
        #controls { 
            position: absolute; 
            top: 10px; 
            left: 50px; /* Mover levemente a la derecha para evitar salida del encuadre */
            z-index: 1000; 
            background: white; 
            padding: 5px; 
            border-radius: 5px; 
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        #map #fullscreen-btn {
            position: absolute;
            bottom: 50px; /* Subido para evitar el logo de Leaflet */
            left: 20px; /* Extremo izquierdo dentro del mapa */
            padding: 5px 10px;
            font-size: 14px;
            font-family: 'Montserrat', sans-serif; /* Usar fuente Montserrat */
            cursor: pointer;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        select { 
            padding: 3px; 
            font-size: 14px; 
            width: 150px; 
            margin-bottom: 3px; 
            display: block;
        }
        /* Media query para móviles */
        @media (max-width: 768px) {
            #map {
                height: 100vh; /* Altura por defecto para móviles */
                width: 100%; /* Ajustado a 100% en móviles */
                min-height: 250px;
            }
            #controls {
                top: 5px;
                left: 20px; /* Ajustado a la derecha en móviles para evitar bordes */
                padding: 3px;
            }
            select {
                width: 120px;
                font-size: 12px;
            }
            .leaflet-popup-content {
                font-size: 8px !important; /* Reducir aún más el tamaño de fuente */
                max-width: 120px !important; /* Reducir ancho del popup */
                line-height: 1.1 !important; /* Ajustar espaciado vertical para legibilidad */
                padding: 3px !important; /* Reducir padding interno */
            }
            .leaflet-popup-content ul {
                padding-left: 8px !important; /* Ajustar indentación de la lista */
            }
            #map #fullscreen-btn {
                font-size: 12px;
                padding: 3px 8px;
                bottom: 40px; /* Subido para evitar el logo en móviles */
                left: 15px; /* Ajuste para móviles */
            }
        }
        .leaflet-popup-content {
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            line-height: 1.4;
        }
        .leaflet-popup-content b {
            font-weight: 700; /* Negrita con Montserrat */
        }
        .leaflet-popup-content .project-name {
            margin-bottom: 10px; /* Separación leve después del name */
        }
        .leaflet-popup-content ul {
            margin-top: 5px; /* Separación leve entre name y la lista */
            padding-left: 20px; /* Ajuste para viñetas */
            list-style-type: disc; /* Viñetas estándar */
        }
        .leaflet-popup-content ul li {
            margin-bottom: 5px; /* Separación leve entre ítems de la lista */
        }
        /* Estilo para pantalla completa */
        :fullscreen #map,
        :-webkit-full-screen #map,
        :-moz-full-screen #map,
        :-ms-fullscreen #map {
            height: 100% !important;
            width: 100% !important;
            min-height: 100% !important;
        }
    </style>
</head>
<body>
    <div id="controls">
        <select id="categoryFilter" onchange="updateProductFilter()">
            <option value="all">Todas las categorías</option>
        </select>
        <select id="productFilter" onchange="filterMarkers()">
            <option value="all">Todos los productos</option>
        </select>
    </div>
    <div id="map">
        <button id="fullscreen-btn">Pantalla completa</button>
    </div>
    <script>
        // Esperar a que el DOM esté listo antes de inicializar
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map', {
                zoomControl: false // Desactivar control de zoom por defecto
            }).setView([9.9281, -84.0907], 8);

            // Usar capa predeterminada de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Mover el control de zoom a la esquina inferior derecha
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // Definir íconos personalizados con colores sutiles por categoría
            var icons = {
                'Agrícola': L.icon({
                    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [0, -41],
                    shadowSize: [41, 41]
                }),
                'Ganadería': L.icon({
                    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-brown.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [0, -41],
                    shadowSize: [41, 41]
                }),
                'Acuícola': L.icon({
                    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [0, -41],
                    shadowSize: [41, 41]
                }),
                'Procesado': L.icon({
                    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [0, -41],
                    shadowSize: [41, 41]
                })
            };

            var projects = [
                {
                    category: "Agrícola",
                    name: "Productos D´Fresa",
                    product: "Fresa",
                    characteristics: "Fresa fresca y congelada",
                    availability: "Todo el año",
                    phone: "8707-9642",
                    email: "No incluido",
                    deliveries: "A cantones vecinos",
                    others: "No incluido",
                    lat: 10.17461859,
                    lng: -84.15852415
                },
                {
                    category: "Agrícola",
                    name: "ASODUCKUA",
                    product: "Plátano",
                    characteristics: "No incluido",
                    availability: "Todo el año",
                    phone: "8773-9008",
                    email: "No incluido",
                    deliveries: "Dentro del cantón",
                    others: "Asociación de personas indígenas",
                    lat: 9.626096579,
                    lng: -82.87477416
                },
                {
                    category: "Agrícola",
                    name: "ASODUCKUA",
                    product: "Cacao",
                    characteristics: "No incluido",
                    availability: "Todo el año",
                    phone: "8773-9008",
                    email: "No incluido",
                    deliveries: "Dentro del cantón",
                    others: "Asociación de personas indígenas",
                    lat: 9.626096579,
                    lng: -82.87477416
                },
                {
                    category: "Acuícola",
                    name: "ASODUCKUA",
                    product: "Pescado",
                    characteristics: "Tilapia",
                    availability: "Todo el año",
                    phone: "8773-9008",
                    email: "No incluido",
                    deliveries: "Dentro del cantón",
                    others: "Asociación de personas indígenas",
                    lat: 9.626096579,
                    lng: -82.87477416
                },
                {
                    category: "Procesado",
                    name: "Entre Aromas",
                    product: "Varios",
                    characteristics: "No incluido",
                    availability: "Todo el año",
                    phone: "8317-5759",
                    email: "No incluido",
                    deliveries: "A cantones vecinos",
                    others: "Proyecto con Bandera Azul Ecológica",
                    lat: 10.53625097,
                    lng: -85.25530138
                },
                {
                    category: "Agrícola",
                    name: "Finca agrícola",
                    product: "Papa",
                    characteristics: "No aportados",
                    availability: "Todo el año",
                    phone: "8881-7544",
                    email: "No incluido",
                    deliveries: "Dentro del cantón",
                    others: "No incluido",
                    lat: 9.916927899,
                    lng: -83.89214605
                },
                {
                    category: "Agrícola",
                    name: "Finca agrícola",
                    product: "Cebolla",
                    characteristics: "No aportados",
                    availability: "Todo el año",
                    phone: "8881-7544",
                    email: "No incluido",
                    deliveries: "Dentro del cantón",
                    others: "No incluido",
                    lat: 9.916927899,
                    lng: -83.89214605
                },
                {
                    category: "Agrícola",
                    name: "Finca agrícola",
                    product: "Zanahoria",
                    characteristics: "No aportados",
                    availability: "Todo el año",
                    phone: "8881-7544",
                    email: "No incluido",
                    deliveries: "Dentro del cantón",
                    others: "No incluido",
                    lat: 9.916927899,
                    lng: -83.89214605
                },
                {
                    category: "Agrícola",
                    name: "Agricarrots Produce and Trading Company S.A.",
                    product: "Papa",
                    characteristics: "Producto lavado. Diversas calidades",
                    availability: "Todo el año",
                    phone: "7122-7486",
                    email: "juanjoramirez1994@gmail.com",
                    deliveries: "Donde se requiera",
                    others: "Proyecto con Buenas Prácticas Agrícolas y de Manufactura",
                    lat: 9.887036196,
                    lng: -83.87008008
                },
                {
                    category: "Agrícola",
                    name: "Agricarrots Produce and Trading Company S.A.",
                    product: "Zanahoria",
                    characteristics: "Producto lavado. Diversas calidades hasta mínimamente procesado para industria",
                    availability: "Todo el año",
                    phone: "7122-7486",
                    email: "juanjoramirez1994@gmail.com",
                    deliveries: "Donde se requiera",
                    others: "Proyecto con Buenas Prácticas Agrícolas y de Manufactura",
                    lat: 9.887036196,
                    lng: -83.87008008
                }
            ];

            var uniqueCategories = [...new Set(projects.map(project => project.category))].sort();
            var categorySelect = document.getElementById('categoryFilter');
            uniqueCategories.forEach(category => {
                var option = document.createElement('option');
                option.value = category;
                option.text = category;
                categorySelect.appendChild(option);
            });

            var productSelect = document.getElementById('productFilter');
            var markersLayer = L.layerGroup().addTo(map);

            // Función para alternar pantalla completa
            var fullscreenBtn = document.getElementById('fullscreen-btn');
            if (fullscreenBtn) {
                console.log("Botón encontrado en el DOM");
                fullscreenBtn.addEventListener('click', function() {
                    console.log("Botón clickeado");
                    var mapElement = document.getElementById('map');
                    if (document.fullscreenEnabled || document.webkitFullscreenEnabled) {
                        if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                            console.log("Intentando entrar a pantalla completa");
                            var promise = mapElement.requestFullscreen 
                                ? mapElement.requestFullscreen() 
                                : mapElement.webkitRequestFullscreen 
                                ? mapElement.webkitRequestFullscreen() 
                                : mapElement.mozRequestFullScreen 
                                ? mapElement.mozRequestFullScreen() 
                                : mapElement.msRequestFullscreen 
                                ? mapElement.msRequestFullscreen() 
                                : Promise.reject(new Error('Fullscreen no soportado'));
                            promise.catch(err => console.error("Error al entrar a fullscreen:", err));
                            this.textContent = 'Salir de pantalla completa';
                        } else {
                            console.log("Intentando salir de pantalla completa");
                            var promise = document.exitFullscreen 
                                ? document.exitFullscreen() 
                                : document.webkitExitFullscreen 
                                ? document.webkitExitFullscreen() 
                                : document.mozCancelFullScreen 
                                ? document.mozCancelFullScreen() 
                                : document.msExitFullscreen 
                                ? document.msExitFullscreen() 
                                : Promise.reject(new Error('Salir de fullscreen no soportado'));
                            promise.catch(err => console.error("Error al salir de fullscreen:", err));
                            this.textContent = 'Pantalla completa';
                        }
                        setTimeout(function() {
                            map.invalidateSize(); // Ajustar el mapa al cambiar de tamaño
                        }, 100);
                    } else {
                        console.log("Pantalla completa no soportada en este navegador");
                        alert("La pantalla completa no está soportada en este navegador.");
                    }
                });
            } else {
                console.error("Botón fullscreen-btn no encontrado en el DOM");
            }

            window.updateProductFilter = function() {
                console.log("updateProductFilter called");
                var selectedCategory = categorySelect.value;
                productSelect.innerHTML = '<option value="all">Todos los productos</option>';
                var filteredProducts = [...new Set(
                    projects
                        .filter(project => selectedCategory === 'all' || project.category === selectedCategory)
                        .map(project => project.product)
                )].sort();
                filteredProducts.forEach(product => {
                    var option = document.createElement('option');
                    option.value = product;
                    option.text = product;
                    productSelect.appendChild(option);
                });
                filterMarkers();
                console.log("Products updated, filtering markers");
            };

            window.filterMarkers = function() {
                console.log("filterMarkers called");
                var selectedCategory = categorySelect.value;
                var selectedProduct = productSelect.value;
                markersLayer.clearLayers();
                projects.forEach(function(project) {
                    if (
                        (selectedCategory === 'all' || project.category === selectedCategory) &&
                        (selectedProduct === 'all' || project.product === selectedProduct)
                    ) {
                        var icon = icons[project.category] || L.icon({
                            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [0, -41],
                            shadowSize: [41, 41]
                        });
                        var marker = L.marker([project.lat, project.lng], { icon: icon }).addTo(markersLayer);
                        marker.bindPopup(
                            '<div class="project-name"><b>' + project.name + '</b></div>' +
                            '<ul>' +
                                '<li><b>Producto:</b> ' + project.product + '</li>' +
                                '<li><b>Características:</b> ' + project.characteristics + '</li>' +
                                '<li><b>Disponibilidad:</b> ' + project.availability + '</li>' +
                                '<li><b>Teléfono:</b> ' + project.phone + '</li>' +
                                '<li><b>Correo:</b> ' + project.email + '</li>' +
                                '<li><b>Entregas:</b> ' + project.deliveries + '</li>' +
                                '<li><b>Otros detalles:</b> ' + project.others + '</li>' +
                            '</ul>'
                        );
                    }
                });
                console.log("Markers filtered with category:", selectedCategory, "and product:", selectedProduct);
                setTimeout(function() {
                    map.invalidateSize();
                }, 100);
            };

            updateProductFilter();
            filterMarkers();
            setTimeout(function() {
                map.invalidateSize();
            }, 200);

            // Depuración básica
            console.log("Mapa inicializado con centro en:", [9.9281, -84.0907]);
        });
    </script>
</body>
</html>

